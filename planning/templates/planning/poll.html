<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
<!-- crossorigin="ano -->
<titLe>Poll</title>
</head>
<style>
  .rectangular-label {
    display: inline-block;
    background-color: #007bff; /* Default background color */
    color: white;
    text-align: center;
    padding: 5px;
    margin: 5px;
    cursor: pointer; /* Change cursor to pointer */
}
</style>
<body>
<div class="container">
  <h2 style="text-align: center;">Ticket Title: <span id="ticket-title"></span></h2>
  <div class="row mt-5 justify-content-center">
    <div id="radioContainer">
      <!-- The select field will be inserted here -->
  </div>
    <div class="col-4">
      <div>
        <label for="username" class="username" class="form-label">Username</label>
        <input id="username" class="form-control" type="text"><br>
      </div>

      <button class="btn btn-primary mt-2" id="button">Click Me</button>
    </div>
  </div>
<div class="row justify-content-center mt -5">
<div class="col-4">
<p id="log"></p>
</div>
</div>
</div>

<script>
  console.log(window.location);
  var url = window.location.href;
  var match = url.match(/\/poll\/(\d+)\/$/);

// Create a URLSearchParams object from the URL
const searchParams = new URLSearchParams(window.location.search);

  // Get the value of a specific query parameter
  var rating = searchParams.get('TicketRating');
  var title = searchParams.get('TicketTitle');
  console.log(title)

  document.querySelector("#ticket-title").textContent = title;
  

  // GENERATE CHOICE FIELDS
    let radioHTML = '';
    const groups = rating.split('/');
    groups.forEach(group => {
        const numbers = group.split(',');
        numbers.forEach(number => {
            // Generate unique ID for each radio button
            const id = `rating${number}`;

            radioHTML += `
              <input type="radio" id="${id}" name="rating" value="${number}" style="display: none;"> <!-- Hide radio buttons -->
              <label class="rectangular-label" for="${id}" style="width: ${5 * 10}px">${number}</label>
        `;
        });
    });


    document.getElementById('radioContainer').innerHTML = radioHTML;
    const radioButtons = document.querySelectorAll('input[type="radio"]');

    // Add event listener for change event
    radioButtons.forEach(radioButton => {
      radioButton.addEventListener('change', function(event) {
          // Log the selected value
          console.log(event.target.value);
          const username = document.querySelector('#username');

          console.log(rating)
          const message = event.target.value + ' clicked the button!';
          
          notificationSocket.send(JSON.stringify({
          'message': message
        }));
        });
    });
    console.log("ANA RATING");
    console.log(searchParams);
    console.log(rating);

  // Extract the number
  var number = match ? match[1] : null;

  console.log(number);
  const notificationSocket = new WebSocket(`ws://${window.location.host}/ws/poll/${number}/`);





  notificationSocket.onmessage = function (e) {
    const data = JSON.parse(e.data) ;
    console.log("AAA11");
    console.log(data.message);
    document.querySelector('#log').innerHTML += (data.message + '<br>');
  };
  notificationSocket.onclose = function (e) {
  console.error('Chat socket closed unexpectedly');
  };



  document.querySelector('#button').onclick = function (e) {
    const username = document.querySelector('#username');

    console.log(rating)
    const message = username.value + ' clicked the button!';
    
    notificationSocket.send(JSON.stringify({
    'message': message
  }));
  };
</script>
</body>
</html>