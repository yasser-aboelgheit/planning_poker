<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" crossorigin="anonymous">
<!-- crossorigin="ano -->
<titLe>Poll</title>
</head>
<style>
  .hidden {
    display: none;
}
  .rectangular-label {
    display: inline-block;
    background-color: #007bff; /* Default background color */
    color: white;
    text-align: center;
    padding: 5px;
    margin: 5px;
    cursor: pointer; /* Change cursor to pointer */
}
</style>
<body>
<div class="container">
  <h2 style="text-align: center;">Ticket Title: <span id="ticket-title"></span></h2>
  
  <div class="row mt-5 justify-content-center">
    <div id="usernameForm">
      <h2>Enter Username</h2>
      <form id="usernameInputForm">
          <input type="text" id="usernameInput" placeholder="Enter Username">
          <button type="button" onclick="showAgeForm()">Next</button>
      </form>
  </div>


    <div id="radioContainer" class="hidden">
      <!-- The select field will be inserted here -->
  </div>
    <!-- <div class="col-4">
      <div>
        <label for="username" class="username" class="form-label">Username</label>
        <input id="username" class="form-control" type="text"><br>
      </div>

      <button class="btn btn-primary mt-2" id="button">Click Me</button>
    </div> -->
  </div>
<div class="row justify-content-center mt -5">
<div class="col-4">
<p id="log"></p>
</div>
</div>
</div>

<script>
  console.log(window.location);
  var url = window.location.href;
  var parts = url.split('/');

  // Get the last part of the URL, which should be the ID
  var lastPart = parts[4];

  // Split the last part by '?' to separate the ID from the query parameters
  var id = lastPart
  
  console.log(id);
  console.log("start");
  console.log(url);

// Create a URLSearchParams object from the URL
const searchParams = new URLSearchParams(window.location.search);

  // Get the value of a specific query parameter
  var rating = searchParams.get('TicketRating');
  var title = searchParams.get('TicketTitle');
  console.log(title)

  document.querySelector("#ticket-title").textContent = title;
  

  // GENERATE CHOICE FIELDS
    let radioHTML = '';
    const groups = rating.split('/');
    groups.forEach(group => {
        const numbers = group.split(',');
        numbers.forEach(number => {
            // Generate unique ID for each radio button
            const id = `rating${number}`;

            radioHTML += `
              <input type="radio" id="${id}" name="rating" value="${number}" style="display: none;"> <!-- Hide radio buttons -->
              <label class="rectangular-label" for="${id}" style="width: ${5 * 10}px">${number}</label>
        `;
        });
    });


    document.getElementById('radioContainer').innerHTML = radioHTML;
    const radioButtons = document.querySelectorAll('input[type="radio"]');

    // Add event listener for change event
    radioButtons.forEach(radioButton => {
      radioButton.addEventListener('change', function(event) {
          // Log the selected value
          console.log(event.target.value);
          const username = document.querySelector('#usernameInput');

          console.log(rating)
          //const message = username.value + ' clicked the button!' + event.target.value ;
          
          notificationSocket.send(JSON.stringify({
          'vote': event.target.value,
          'username': username.value
        }));
        });
    });
    console.log("ANA RATING");
    console.log(searchParams);
    console.log(rating);

  // Extract the number
  console.log("ANA RATING22");

  const notificationSocket = new WebSocket(`ws://${window.location.host}/ws/poll/${id}/`);





  notificationSocket.onmessage = function (e) {
    const data = JSON.parse(e.data) ;
    console.log("AAA11");
    console.log(data.message);
    console.log(data.type);
    console.log(data.username);

    //consloe.log(data.username);
    console.log(typeof data.message);
    document.querySelector('#log').innerHTML = '';
    for (let key in data.message) {
      console.log(key, data.message[key]);
      document.querySelector('#log').innerHTML += (data.message[key] + '<br>');
    }
    
    //document.querySelector('#log').innerHTML = (data.message + '<br>');
  };
  notificationSocket.onclose = function (e) {
  console.error('Chat socket closed unexpectedly');
  };


/*
  document.querySelector('#button').onclick = function (e) {
    const username = document.querySelector('#username');

    console.log(rating)
    const message = username.value + ' clicked the button!';
    
    notificationSocket.send(JSON.stringify({
    'message': message
  }));
  };
*/

  function showAgeForm() {
    // Hide username form
    document.getElementById('usernameForm').classList.add('hidden');
    /*const username = document.querySelector('#usernameInput');
    notificationSocket.send(JSON.stringify({
      'username': username.value
    }));*/
    // Show age form
    document.getElementById('radioContainer').classList.remove('hidden');
}
</script>
</body>
</html>